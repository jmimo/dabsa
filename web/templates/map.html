{% extends "layout.html" %}
{% block content %}
<div class="container-fluid fill">
  <div id="mymap" class="google-map"></div>
</div>
{% endblock %}
{% block script %}
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=drawing&sensor=false"></script>
<script type="text/javascript" src="{{ url_for('static', filename='dabsa/dabsa.js') }}"></script>
<script type="text/javascript">
  var currentSelection;
  var confirmWindow;

  function loadMap() {
  var map = new google.maps.Map(document.getElementById('mymap'), {
    center: new google.maps.LatLng(46.801111111111105, 8.226666666666667),
    zoom: 8,
    mapTypeId: google.maps.MapTypeId.SATELLITE
  });
  loadDrawingManager(map); 
  }

 /* google.maps.event.addDomListener(window, 'load', function() {
    map = initialize_google_map('mymap', new google.maps.LatLng(46.801111111111105, 8.226666666666667), 8);
  });*/

  google.maps.event.addDomListener(window, 'load', loadMap());

  function loadDrawingManager(map) {
  var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.POLYGON,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: [google.maps.drawing.OverlayType.POLYGON]
    },
    polygonOptions: {
      draggable: true,
      editable: true,
      strokeColor: '#FF6600',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FFCC00',
      fillOpacity: 0.35
    }  
  });
  drawingManager.setMap(map);

  google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
    google.maps.event.addListener(polygon, 'rightclick', function(event) {
      currentSelection = polygon;
      confirmWindow = new google.maps.InfoWindow({
       content: '<div class="container-fluid"><b>Selection</b><br/><div class="btn-group btn-group-xs"><button class="btn btn-primary btn-success ladda-button" data-style="zoom-in" onclick="fetchSelectionData()"><span class="ladda-label">Submit</span><span class="ladda-spinner"></span></button><button class="btn btn-danger" onclick="removeSelection()">Remove</button></div></div>'
      });
      confirmWindow.setPosition(event.latLng);
      confirmWindow.open(map);
      Ladda.bind('button');
    });
  });
  }

  function removeSelection() {
    if(currentSelection) {
      currentSelection.setEditable(false);
      currentSelection.setMap(null);
      currentSelection = null;
    }
    confirmWindow.close();
  }

  function fetchSelectionData() {
    if(currentSelection) {
      var data = [];
      currentSelection.getPath().forEach(function(latlng,i) {
        data['point_' + i] = latlng.lat() + ':' + latlng.lng();
      });
      alert(data);
      $.post('/ajax/selection', {
        polygon: data 
      }, function(response) {
        confirmWindow.close();
        alert('Welcome Back');
      });
    }
  }

  /*$(document).ready(function load(){
    
  });*/
</script>
{% endblock %}
